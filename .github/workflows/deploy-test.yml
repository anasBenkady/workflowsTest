name: Publish Packages to Verdaccio

on:
  push:
    branches:
      - development

jobs:
  setup_matrix:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v3

      - name: Install jq
        run: sudo apt-get install jq

      - id: set-matrix
        run: |
          PACKAGES_INFO="[]"
          for PACKAGE in $(find . -name 'package.json' -not -path '*/node_modules/*' -exec dirname {} \;); do
            NAME=$(jq -r '.name' $PACKAGE/package.json)
            LOCAL_DEPS=$(jq -r '.dependencies | to_entries[] | select(.value | startswith("file:")) | .key' $PACKAGE/package.json)
            PACKAGES_INFO=$(echo $PACKAGES_INFO | jq -c --arg pkg $PACKAGE --arg name "$NAME" --arg deps "$LOCAL_DEPS" '. += [{"package": $pkg, "name": $name, "dependencies": ($deps | split("\n") | map(select(. != "")))]}')
          done
          echo "matrix={\"include\":$PACKAGES_INFO}" >> $GITHUB_OUTPUT
        shell: bash


